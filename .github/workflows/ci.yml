name: CI Pipeline

on: push

jobs:
  test:
    name: Unit Test (pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run pytest
        run: pytest

  sast:
    name: Static Application Security Testing (Bandit)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit (skip assert rule B101)
        run: bandit -r . -x B101

  sca:
    name: Software Composition Analysis (pip-audit)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: pip-audit

  secret-scan:
    name: Secret Scan (Gitleaks)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3

      - name: Run Gitleaks
        uses: zricethezav/gitleaks-action@v1
        with:
          args: detect --source=. --verbose

  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [test, sast, sca, secret-scan]
    steps:
      - uses: actions/checkout@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: yourdockerhubusername/yourimage:latest

  trivy-scan:
    name: Image Scan (Trivy)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Trivy Scan Docker Image
        uses: aquasecurity/trivy-action@v0.10.0
        with:
          image-ref: yourdockerhubusername/yourimage:latest

